<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Image → Text → Summary</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --muted: #94a3b8;
        --fg: #e5e7eb;
        --accent: #22d3ee;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font: 14px/1.45 system-ui, Segoe UI, Arial;
      }
      .wrap {
        max-width: 960px;
        margin: 32px auto;
        padding: 0 16px;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 12px;
      }
      .card {
        background: var(--panel);
        border-radius: 12px;
        padding: 16px;
        margin: 12px 0;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      label {
        display: block;
        font-weight: 600;
        margin: 0 0 6px;
      }
      input[type="text"],
      textarea,
      select {
        width: 100%;
        background: #0b1220;
        border: 1px solid #1f2937;
        color: var(--fg);
        border-radius: 8px;
        padding: 10px;
      }
      textarea {
        min-height: 140px;
      }
      button {
        background: var(--accent);
        color: #042c2c;
        border: 0;
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
      }
      pre {
        white-space: pre-wrap;
        background: #0b1220;
        border: 1px solid #1f2937;
        padding: 12px;
        border-radius: 8px;
      }
      small {
        color: var(--muted);
      }
      code {
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Image → Text → Summary</h1>

      <!-- Health (kept, now uses a fixed API base) -->
      <div class="card">
        <div
          class="row"
          style="justify-content: space-between; align-items: center"
        >
          <div>
            <strong>Backend Health</strong><br />
            <small>Using API: <code id="apiDisplay"></code></small>
          </div>
          <div>
            <button id="healthBtn">Recheck Health</button>
          </div>
        </div>
        <pre id="healthOut">Click “Recheck Health”.</pre>
      </div>

      <!-- NEW: Upload image → generate text (OCR only) -->
      <div class="card">
        <h2 style="margin-top: 0">Upload Image → Generate Text</h2>
        <div class="row">
          <input id="file" type="file" accept="image/*,.pdf" />
          <button id="ocrBtn">Generate Text</button>
        </div>
        <small
          >Tip: After text is generated below, it’s auto-copied into the summary
          box for you.</small
        >
        <label style="margin-top: 10px">Extracted Text</label>
        <textarea
          id="ocrText"
          placeholder="Your extracted text will appear here…"
          readonly
        ></textarea>
      </div>

      <!-- Summarize text (unchanged, now fed by the OCR step above) -->
      <div class="card">
        <h2 style="margin-top: 0">Summarize Text</h2>
        <div class="row">
          <div style="flex: 1">
            <label>Format</label>
            <select id="fmt">
              <option value="plain">plain</option>
              <option value="bullets">bullets</option>
              <option value="markdown">markdown</option>
            </select>
          </div>
        </div>
        <label>Text</label>
        <textarea
          id="text"
          placeholder="Paste or use generated text from above…"
        ></textarea>
        <div class="row" style="margin-top: 8px">
          <button id="sumBtn">Summarize</button>
        </div>
        <pre id="sumOut"></pre>
      </div>
    </div>

    <!-- Set your API once here (no input field on screen). 
     IMPORTANT: If this page is on HTTPS (Vercel), API must also be HTTPS. -->
    <script>
      // CHANGE THIS for production:
      // e.g. window.API_BASE = "https://your-domain.example.com";
      window.API_BASE = window.API_BASE || "http://127.0.0.1:18080";
    </script>

    <script>
      const $ = (id) => document.getElementById(id);
      const API_BASE = (window.API_BASE || "").replace(/\/+$/, "");
      $("apiDisplay").textContent = API_BASE;

      async function getJSON(url, opts) {
        const r = await fetch(url, opts);
        const t = await r.text();
        let d = t;
        try {
          d = JSON.parse(t);
        } catch {}
        if (!r.ok)
          throw new Error(typeof d === "string" ? t : JSON.stringify(d));
        return d;
      }

      // Health
      $("healthBtn").onclick = async () => {
        $("healthOut").textContent = "Loading…";
        try {
          const d = await getJSON(`${API_BASE}/health`);
          $("healthOut").textContent = JSON.stringify(d, null, 2);
        } catch (e) {
          $("healthOut").textContent = "Error: " + e.message;
        }
      };

      // OCR → generate text only
      $("ocrBtn").onclick = async () => {
        const f = $("file").files[0];
        if (!f) {
          alert("Choose an image/PDF first.");
          return;
        }
        $("ocrText").value = "Extracting…";
        try {
          const fd = new FormData();
          fd.append("file", f);
          const d = await getJSON(`${API_BASE}/infer/ocr`, {
            method: "POST",
            body: fd,
          });
          const text = d && d.text ? d.text : "";
          $("ocrText").value = text || "(No text found)";
          // also place it into the summary input for convenience
          $("text").value = text;
        } catch (e) {
          $("ocrText").value = "Error: " + e.message;
        }
      };

      // Summarize text
      $("sumBtn").onclick = async () => {
        $("sumOut").textContent = "Summarizing…";
        try {
          const body = JSON.stringify({ text: $("text").value });
          const fmt = encodeURIComponent($("fmt").value);
          const d = await getJSON(`${API_BASE}/infer/text?fmt=${fmt}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body,
          });
          $("sumOut").textContent = JSON.stringify(d, null, 2);
        } catch (e) {
          $("sumOut").textContent = "Error: " + e.message;
        }
      };
    </script>
  </body>
</html>
